# はじめに
この記事では当時、配属一ヶ月の新卒バックエンドエンジニアの私が自社SaaSの生成AI機能を担当したときの経験を体験談として紹介しようと思います。当初、エンジニアとして右も左もわからない自分がどのようにしてこの機能の制作を担当できたのか、そこから得られる学びもあると思うので是非ご覧ください！
# 事の経緯
その当時、私はおよそ二ヶ月半の研修を終え、配属から一ヶ月ほど経過したときでした。プロジェクトにもなんとか慣れてきた際に私はこの機能を任されることになりました。MTGで突然、私がこの機能を担当すると聞いた時、正直ビックリしたのを覚えています。ここからおよそ数週間による私と生成AIとの戦いが始まりました。
# 要件(言える範囲で)
言える範囲にはなりますが要件は以下のようになります。
- html形式のデータを今までの入力項目を元に別の入力項目の回答を生成する
  - このデータは割と文字数が多い
- 入力項目はユーザーがが自由に作れる可変項目
  - 可変項目にはいくつかの種類が存在する
- プロジェクトではAWSを用いており、それもあってAmazon Bedrockを用いることが検討されている
- SaaSはNext.jsでのフルスタック構成
# まずはデモ作り
まず上司から指示されたのはデモ作りです。Next.jsのフルスタック構成でどのようにAmazon Bedrockを導入すればいいのかしらべてほしいとのことでした。ここでも沢山の課題が降りかかってきました

## 環境構築
エンジニアが何かを始めるとき、大体苦しめられるのがこの環境構築です。とはいえ今時はDockerがあるのでそんなに問題にならないケースも多いのですが、新卒の自分はDockerで環境構築などしたことがなく、それ故に苦戦しました。ただ、現代ではありがたいことにGPTがあるので知らなくてもそれなりのことはできてしまいます。

### GPTの嘘つき!!!!

ところがどっこい、GPTも嘘をついてくれました。指示した通りのDockerFileを用いてもエラーの連続です(当然と言えば当然だが)。ここからエラーとの戦いです。エラーの意味をGPTに聞いて修正をかけ、おかしいと思った部分は指摘したり自分で調べたりしながら原因を探っていきます。

原因を探っていくとどうやらネットに転がってるNext.jsのイメージ生成の記事は基本的に**npmでpackage.jsonをローカルで生成してそれをコンテナにコピーしてコンテナを作る**構成となっており、おそらくそれを参考に回答を生成していることが原因のようでした。

例えば[これ](https://zenn.dev/peishim/articles/de0dd58ba89ca8)とか

ただローカル環境をいじるのも嫌だったため別コンテナでpackage.jsonを生成してからイメージ生成するという形で落ち着きました。

## AWS、Amazon Bedrockとの接続

新卒エンジニアの私は自分でAWSをいじった経験がなく、接続方法もよくわかりませんでした。ただここに関しては別チームのエンジニアの方がサポートして下さりました。この方をAさんとしますが、Aさんのおかげで事なきを得ました。また、そのエンジニアの方の勧めでモデルには[Claude](https://aws.amazon.com/jp/bedrock/claude/)を用いることになりました。

## 実装
で、どうやって実装していくの?って話でしたがここは以外とシンプルでモロに[公式ドキュメント](https://docs.aws.amazon.com/ja_jp/code-library/latest/ug/bedrock-runtime_example_bedrock-runtime_Converse_CohereCommand_section.html)に実装方法がのってました。
あとはこれを元にフロントやバックエンドのコードを作っていけばデモの完成です。

デモ画像挿入予定

# プロンプト研究
生成AIなのでもちろんプロンプトを考えなければいけません。チャット形式の返答をそのまま採用するわけにもいかず、指定した回答項目を埋める回答を的確に生成されるプロンプトを考えなくてはなりません。
一体何を参考にしたものか、、、と当初は悩んだのですがこの疑問もアッサリ解決することになります。というのもプロンプトエンジニアリングの方法も[公式ドキュメント](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview)に載っていたからです

## トライ&エラー
とはいえここからはトライ&エラーとなります。ドキュメントに記載されているテクニックを適用しつつ、ベストな回答を生成できるように調整をかけていきます。

私は公式ドキュメントを参考にしながら、まずは以下のテクニックを試しました。
テクニックの詳細については公式ドキュメントをご覧ください

- 段階的に考えさせる
- xmlを用いる
- システムプロンプトを用いる
- 文書の関連部分を引用するように Claude に依頼する

そうするとこんな感じのプロンプトを組む事ができます
```xml
あなたはhtmlをもとに回答を生成するエージェントです。
今までの回答を参考にquestionの回答を考えて 
<htmlData>
htmlのデータ
</htmlData> 
<draftAnswers>
今までの項目の回答
</draftIdeas> 
<question>
回答したい項目
</question> 
提案するにあたり、まず関連する背景情報を調べて引用してください。 
次に、回答について段階的に思考を練り上げてください。 
最後にN文字程度の回答を出力してください。 出力は以下のフォーマットに従ってください。 

<quotes> 関連する背景情報の引用 </quotes> 
<thoughtProcess> アイデアを練り上げる過程 </thoughtProcess> 
<answer> 
回答(N文字程度) 
</answer> 

```

ですが思うようにいかず、期待した通りでない出力が続きました。その中でも最たるものがなぜかanswerタグが回答内容に沿ったタグに変更されている点です。
後々にしてわかったことですがこのプロンプトには以下の問題がありました

### html形式のデータが長く、うまくclaudeがプロンプト全体を把握できない

生成AIは長い長文を認識しずらい、という話を聞いた事がある方は多いのではないでしょうか?これは実際その通りでして、公式ドキュメントにも[長文をどのようにプロンプトに落とし込むかというテクニック](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/long-context-tips)が紹介されていました。

これを参考にhtml要約用のプロンプトを別途用いることでこの問題は解消できました。

```xml
あなたはプロンプトエンジニアです
プロンプトに読み込ませたい募集要項を要約することを求められています

以下のHTML形式のデータをテキストとして要約して
<htmlData>
${siteProgramRequirement.html}
</htmlData>
回答は以下の形式に従って
<outputFormat>
<htmlDataSummary>
募集要項の要約
</htmlDataSummary>
</outputFormat>
```

### 回答形式の指定が弱く他に引っ張られてしまう

現在、以下のような形で回答形式を組んでいます

```xml
<quotes> 関連する背景情報の引用 </quotes> 
<thoughtProcess> アイデアを練り上げる過程 </thoughtProcess> 
<answer> 
回答(N文字程度) 
</answer> 
```

現状この状態では質問内容などに回答形式が引っ張られてしまいます。これに対してどうにかするには**これが回答形式であることをより明示的にする**必要がありました。

また、回答がanswerタグで指定しています。　公式ドキュメントの例には**回答してほしいものをより明示的にタグにしている**ことが多かったのですが、それができていないのが原因なのではないのかと考えれらました。例えばタイトルを考えて欲しかったら`<title>`というタグで囲む必要があるのです。

これらを考慮して以下の改善を加えることにしました
- 回答形式を`<outputFormat>`タグで囲む
- answerタグを質問内容のタグに変えてしまう。

また、このときついでにdraftAnswersの内容も同様に質問内容のタグで補強することでより精度を向上できそうなので改良しました。
最終的にはこのようなプロンプトを作り上げることができました。

```xml
あなたはhtmlをもとに回答を生成するエージェントです。
今までの回答を参考にquestionの回答を考えて 
<htmlDataSummary>
htmlのデータ
</htmlDataSummary> 
<draftAnswers>
<今までの質問1>
今までの回答1
</今までの質問1>
<今までの質問2>
今までの回答2
</今までの質問2>
・
・
・
<今までの質問N>
今までの回答N
</今までの質問N>
</draftIdeas> 
<question>
回答したい項目
</question> 
提案するにあたり、まず関連する背景情報を調べて引用してください。 
次に、回答について段階的に思考を練り上げてください。 
最後にN文字程度の回答を出力してください。 出力は以下のフォーマットに従ってください。 

<outputFormat>
<quotes> 関連する背景情報の引用 </quotes> 
<thoughtProcess> アイデアを練り上げる過程 </thoughtProcess> 
<回答したい項目> 
回答(N文字程度) 
</回答したい項目> 
</outputFormat>

```
# 考えなきゃいけないものが多すぎる!
プロンプトも出来たし、あとは組み込めばOK!
そんなことを思っていた時期が私にもありました。ですが新しいものを組み込むとなると考慮、調査しなければならないものが沢山あったのです。
思い出せる限りでも以下の通り、、、

- モデルの種類
  - 性能と料金
- ストリームを用いるかどうか
- 回答項目のサニタイズ
- ジョブで処理を切り出すかどうか
- 生成が成功しなかった場合のエラーハンドリング
- etc...

全部書いてるとキリがなさそうなので割愛しますが**一人でこれら全ての問題点を列挙して考慮することは当時の自分にはできませんでした。**
特にジョブに切り出すかどうかに関してはNode.jsの[ノンブロックキングIOの性質](https://knowledge.sakura.ad.jp/24148/#C10K)を含めた判断をしなくてはならないため、到底自分には不可能でした。(今でもちゃんと理解してるか怪しい)

これらを全て解消することによってようやく設計に踏み込むことができました

# 完成!
これらの問題を解消し、設計、実装が完了し機能が完成しました！
実際にポチポチ触ってみましたがかなり高精度に回答を生成できました

# この出来事で学んだ事
## 新しい技術を導入するのは大変
結局コレに尽きると思います。導入に至ってはまず**何を考慮すべきなのか考慮できる**必要がありました。これが欠けていると後々トラブルを引き起こすことになります。
これを自分でするのがある意味最も大変な事でした。

## 生成AIの実装は以外とシンプル
プロンプトさえそれなりのものが組めてしまえば、あとの実装は以外と簡単でした。
また、プロンプトそのものも自分にとっては大変でしたが**配属一ヶ月の新卒が一週間あれば作れました**。つまり多分やること自体はそんなに難しくなさそうです(あくまで主観ですが)。また、プロンプトを組むための情報も公式ドキュメントに丁寧に記載されてますし、世間が思っているよりは簡単なんじゃないかと思います。

## 実装に至るまでの調査や設計ができる事の大切さ
今までは実装フェーズを担当することが多く、実装をしっかりできることが素晴らしいと思っていたのですが、
実は**実装に至るまでの調査や設計ができる事ってコーディングできることより大切なのではないか**???と思えました。
実際、調査が終わって実装フェーズになってからはそんなに実装に苦戦しませんでした。というのも何をしていいかがちゃんと分かってたからです。調査担当が自分だったというのもあると思いますがこれは他人がやっても概ね同じだったと思います。
一方、先述したとおり**何を考慮すべきなのか考慮し、調査**する方が何倍も大変でした。これは普段の設計業務にも言えることで、仕様やその機能でやりたい事、保守性、拡張性など**あらゆることを考慮したベストプラクティス**を考える必要があります。一方でその**ベストプラクティスが用意されている実装フェーズでも考慮することはありますが、それは設計の範囲の話に収まります**(もちろん例外や実装フェーズで発生する問題もあると思いますが)
こういった事から私は**実装に至るまでの調査や設計ができる事の大事さ**を学べました。
# さいごに
長くなってしまいましたが、以上が
配属一ヶ月の新卒バックエンドエンジニアの私が自社SaaSの生成AI機能を担当したときの経験を体験談とその気づきです。
この体験談がみなさんにとって何かしらの気づきになることを願っています。
